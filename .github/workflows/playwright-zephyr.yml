name: Playwright + Zephyr (Legacy)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 9 * * *'   # diario 9am UTC
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 90
    runs-on: ubuntu-latest

    strategy:
      matrix:
        env: [dev, qa, app]

    steps:
      # 1Ô∏è‚É£ Checkout del repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Instalar dependencias
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Instalar navegadores Playwright
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 5Ô∏è‚É£ Ejecutar tests seg√∫n el environment
      - name: Run Playwright tests
        env:
          TARGET_ENV: ${{ matrix.env }}
          DEV_USER_EMAIL: ${{ secrets.DEV_USER_EMAIL }}
          DEV_USER_PASSWORD: ${{ secrets.DEV_USER_PASSWORD }}
          QA_USER_EMAIL: ${{ secrets.QA_USER_EMAIL }}
          QA_USER_PASSWORD: ${{ secrets.QA_USER_PASSWORD }}
          APP_USER_EMAIL: ${{ secrets.APP_USER_EMAIL }}
          APP_USER_PASSWORD: ${{ secrets.APP_USER_PASSWORD }}
        run: |
          echo "Running tests for ENV=${{ matrix.env }}"
          if [ "${{ matrix.env }}" = "dev" ]; then
            npm run test:dev
          elif [ "${{ matrix.env }}" = "qa" ]; then
            npm run test:qa
          else
            npm run test:app
          fi

      # 6Ô∏è‚É£ Convertir results.json a Zephyr JSON
      - name: Convert results.json to Zephyr JSON
        run: |
          npx ts-node scripts/convert-to-zephyr.ts
        # No necesitas NODE_OPTIONS si tu script es CommonJS

      # 7Ô∏è‚É£ Subir resultados a Zephyr Legacy
      - name: Upload results to Zephyr Legacy
        if: always()
        continue-on-error: true
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          echo "üöÄ Subiendo resultados a Zephyr Legacy..."
          ZEPHYR_ENDPOINT="https://api.zephyrscale.smartbear.com/v2/testexecutions"

          if [ ! -f "test-results/zephyr.json" ]; then
            echo "‚ö†Ô∏è zephyr.json no encontrado"
            ls -la test-results/
            exit 1
          fi

          response_code=$(curl -s -w "\n%{http_code}" -o /tmp/zephyr_response.json \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: application/json" \
            -X POST \
            -d @test-results/zephyr.json \
            "$ZEPHYR_ENDPOINT")

          http_code=$(echo "$response_code" | tail -n1)
          echo "üì® C√≥digo HTTP: $http_code"

          if [ -f "/tmp/zephyr_response.json" ]; then
            echo "üìÑ Respuesta de la API:"
            cat /tmp/zephyr_response.json
          fi

          case $http_code in
            200|201) echo "‚úÖ √âXITO! Resultados subidos a Zephyr Legacy";;
            400) echo "‚ùå Bad Request (400)";;
            401) echo "‚ùå Unauthorized (401)";;
            403) echo "‚ùå Forbidden (403)";;
            404) echo "‚ùå Not Found (404)";;
            *) echo "‚ùå Error desconocido (HTTP $http_code)";;
          esac

      # 8Ô∏è‚É£ Subir reporte HTML de Playwright
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.env }}
          path: playwright-report/
          retention-days: 30
