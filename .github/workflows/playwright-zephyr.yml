name: Playwright + Zephyr (Unified)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 9 * * *'   # diario 9am UTC
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    strategy:
      matrix:
        env: [dev, qa, app]

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Deps
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Playwright browsers
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 5Ô∏è‚É£ Run tests (seg√∫n env)
      - name: Run Playwright tests
        env:
          TARGET_ENV: ${{ matrix.env }}

          DEV_USER_EMAIL: ${{ secrets.DEV_USER_EMAIL }}
          DEV_USER_PASSWORD: ${{ secrets.DEV_USER_PASSWORD }}

          QA_USER_EMAIL: ${{ secrets.QA_USER_EMAIL }}
          QA_USER_PASSWORD: ${{ secrets.QA_USER_PASSWORD }}

          APP_USER_EMAIL: ${{ secrets.APP_USER_EMAIL }}
          APP_USER_PASSWORD: ${{ secrets.APP_USER_PASSWORD }}

        run: |
          echo "Running tests for ENV=${{ matrix.env }}"
          if [ "${{ matrix.env }}" = "dev" ]; then
            npm run test:dev
          elif [ "${{ matrix.env }}" = "qa" ]; then
            npm run test:qa
          else
            npm run test:app
          fi

      # 6Ô∏è‚É£ Upload Playwright HTML report
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.env }}
          path: playwright-report/
          retention-days: 30

      # 7Ô∏è‚É£ DIAGN√ìSTICO: Verificar todas las variables
      - name: Debug - Check all variables
        if: always()
        run: |
          echo "üîç ==========================================="
          echo "üîç DEBUG: VERIFICANDO TODAS LAS VARIABLES"
          echo "üîç ==========================================="
          
          # Variables del workflow
          echo "üìå MATRIX ENV: ${{ matrix.env }}"
          echo "üìå TARGET_ENV: $TARGET_ENV"
          
          # Variables de Jira/Zephyr (SENSIBLES - mostrar solo si existen)
          echo ""
          echo "üîê JIRA/ZEPHYR VARIABLES:"
          
          if [ -n "$JIRA_EMAIL" ]; then
            EMAIL_PREFIX=$(echo "$JIRA_EMAIL" | cut -c1-3)
            echo "‚úÖ JIRA_EMAIL: ${EMAIL_PREFIX}... (seteado, longitud: ${#JIRA_EMAIL})"
          else
            echo "‚ùå JIRA_EMAIL: NO SETEADO"
          fi
          
          if [ -n "$JIRA_API_TOKEN" ]; then
            echo "‚úÖ JIRA_API_TOKEN: SETEADO (longitud: ${#JIRA_API_TOKEN})"
          else
            echo "‚ùå JIRA_API_TOKEN: NO SETEADO"
          fi
          
          if [ -n "$JIRA_BASE_URL" ]; then
            echo "‚úÖ JIRA_BASE_URL: $JIRA_BASE_URL"
          else
            echo "‚ùå JIRA_BASE_URL: NO SETEADO"
          fi
          
          if [ -n "$JIRA_PROJECT_KEY" ]; then
            echo "‚úÖ PROJECT_KEY: '$JIRA_PROJECT_KEY' (longitud: ${#JIRA_PROJECT_KEY})"
            
            if [[ "$JIRA_PROJECT_KEY" =~ ^[A-Z]+$ ]]; then
              echo "   ‚úì Formato v√°lido: solo letras may√∫sculas"
            else
              echo "   ‚ö†Ô∏è  Formato inusual: '$JIRA_PROJECT_KEY'"
            fi
          else
            echo "‚ùå‚ùå‚ùå PROJECT_KEY: NO SETEADO - ESTE ES EL PROBLEMA PROBABLE"
          fi
          
          echo ""
          echo "üìÅ VERIFICANDO ARCHIVOS DE RESULTADOS:"
          ls -la test-results/ || echo "No hay directorio test-results"
          
          echo ""
          echo "üîç ==========================================="
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}

      # 8Ô∏è‚É£ Upload results to Zephyr (Jira)
      - name: Upload results to Zephyr Scale
        if: always()
        continue-on-error: true
        run: |
          echo "üöÄ Subiendo resultados a Zephyr Scale..."
          
          if [ -z "$JIRA_PROJECT_KEY" ]; then
            echo "‚ùå ERROR: JIRA_PROJECT_KEY no est√° definido"
            exit 1
          fi
          
          if [ ! -f "test-results/junit.xml" ]; then
            echo "‚ö†Ô∏è junit.xml no encontrado"
            ls -la test-results/ || true
            exit 1
          fi
          
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
          TEST_CYCLE_NAME="Playwright Tests - ${{ matrix.env }} - $TIMESTAMP"
          
          response_code=$(curl -s -w "\n%{http_code}" -o /tmp/zephyr_response.json \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: multipart/form-data" \
            -F "file=@test-results/junit.xml" \
            -F "projectKey=$JIRA_PROJECT_KEY" \
            -F "testCycle=$TEST_CYCLE_NAME" \
            -F "autoCreateTestCases=true" \
            "$JIRA_BASE_URL/rest/atm/1.0/testrun/import")
          
          http_code=$(echo "$response_code" | tail -n1)
          echo "üì® C√≥digo HTTP: $http_code"
          
          if [ -f "/tmp/zephyr_response.json" ]; then
            echo "üìÑ Respuesta de la API:"
            cat /tmp/zephyr_response.json
          fi
          
          case $http_code in
            200|201)
              echo "‚úÖ √âXITO! Resultados subidos a Zephyr Scale"
              ;;
            400)
              echo "‚ùå Bad Request (400)"
              ;;
            401)
              echo "‚ùå Unauthorized (401)"
              ;;
            403)
              echo "‚ùå Forbidden (403)"
              ;;
            404)
              echo "‚ùå Not Found (404) - revisa URL y que Zephyr Scale est√© instalado"
              ;;
            *)
              echo "‚ùå Error desconocido (HTTP $http_code)"
              ;;
          esac
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
