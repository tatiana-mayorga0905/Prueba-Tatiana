name: Playwright + Zephyr (Unified)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 9 * * *'   # diario 9am UTC
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    strategy:
      matrix:
        env: [dev, qa, app]

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Deps
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Playwright browsers
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 5Ô∏è‚É£ Run tests (seg√∫n env)
      - name: Run Playwright tests
        env:
          TARGET_ENV: ${{ matrix.env }}

          DEV_USER_EMAIL: ${{ secrets.DEV_USER_EMAIL }}
          DEV_USER_PASSWORD: ${{ secrets.DEV_USER_PASSWORD }}

          QA_USER_EMAIL: ${{ secrets.QA_USER_EMAIL }}
          QA_USER_PASSWORD: ${{ secrets.QA_USER_PASSWORD }}

          APP_USER_EMAIL: ${{ secrets.APP_USER_EMAIL }}
          APP_USER_PASSWORD: ${{ secrets.APP_USER_PASSWORD }}

        run: |
          echo "Running tests for ENV=${{ matrix.env }}"
          if [ "${{ matrix.env }}" = "dev" ]; then
            npm run test:dev
          elif [ "${{ matrix.env }}" = "qa" ]; then
            npm run test:qa
          else
            npm run test:app
          fi

      # 6Ô∏è‚É£ Upload Playwright HTML report
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.env }}
          path: playwright-report/
          retention-days: 30

      # 7Ô∏è‚É£ DIAGN√ìSTICO: Verificar todas las variables
      - name: Debug - Check all variables
        if: always()
        run: |
          echo "üîç ==========================================="
          echo "üîç DEBUG: VERIFICANDO TODAS LAS VARIABLES"
          echo "üîç ==========================================="
          
          # Variables del workflow
          echo "üìå MATRIX ENV: ${{ matrix.env }}"
          echo "üìå TARGET_ENV: $TARGET_ENV"
          
          # Variables de Jira/Zephyr (SENSIBLES - mostrar solo si existen)
          echo ""
          echo "üîê JIRA/ZEPHYR VARIABLES:"
          
          # JIRA_EMAIL (mostrar solo primeros caracteres por seguridad)
          if [ -n "$JIRA_EMAIL" ]; then
            EMAIL_PREFIX=$(echo "$JIRA_EMAIL" | cut -c1-3)
            echo "‚úÖ JIRA_EMAIL: ${EMAIL_PREFIX}... (seteado, longitud: ${#JIRA_EMAIL})"
          else
            echo "‚ùå JIRA_EMAIL: NO SETEADO"
          fi
          
          # JIRA_API_TOKEN (solo indicar si existe)
          if [ -n "$JIRA_API_TOKEN" ]; then
            echo "‚úÖ JIRA_API_TOKEN: SETEADO (longitud: ${#JIRA_API_TOKEN})"
          else
            echo "‚ùå JIRA_API_TOKEN: NO SETEADO"
          fi
          
          # JIRA_BASE_URL
          if [ -n "$JIRA_BASE_URL" ]; then
            echo "‚úÖ JIRA_BASE_URL: $JIRA_BASE_URL"
          else
            echo "‚ùå JIRA_BASE_URL: NO SETEADO"
          fi
          
          # PROJECT_KEY - ¬°LA M√ÅS IMPORTANTE!
          if [ -n "$PROJECT_KEY" ]; then
            echo "‚úÖ PROJECT_KEY: '$PROJECT_KEY' (longitud: ${#PROJECT_KEY})"
            
            # Validar formato del Project Key
            if [[ "$PROJECT_KEY" =~ ^[A-Z]+$ ]]; then
              echo "   ‚úì Formato v√°lido: solo letras may√∫sculas"
            else
              echo "   ‚ö†Ô∏è  Formato inusual: '$PROJECT_KEY'"
              echo "   ‚ÑπÔ∏è  Los Project Keys suelen ser solo letras may√∫sculas (ej: TEST, QA, PROJ)"
            fi
          else
            echo "‚ùå‚ùå‚ùå PROJECT_KEY: NO SETEADO - ESTE ES EL PROBLEMA PROBABLE"
            echo "   ‚ÑπÔ∏è  Agrega 'PROJECT_KEY' en GitHub Secrets"
          fi
          
          echo ""
          echo "üìÅ VERIFICANDO ARCHIVOS DE RESULTADOS:"
          ls -la test-results/ || echo "No hay directorio test-results"
          
          echo ""
          echo "üîç ==========================================="
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          PROJECT_KEY: ${{ secrets.PROJECT_KEY }}

      # 8Ô∏è‚É£ Upload results to Zephyr (Jira) - VERSI√ìN CORREGIDA
      - name: Upload results to Zephyr Scale
        if: always()
        continue-on-error: true
        run: |
          echo "üöÄ ==========================================="
          echo "üì§ SUBIENDO RESULTADOS A ZEPHYR SCALE"
          echo "üöÄ ==========================================="
          
          # 1. Verificar que PROJECT_KEY est√© definido
          if [ -z "$PROJECT_KEY" ]; then
            echo "‚ùå‚ùå‚ùå ERROR CR√çTICO: PROJECT_KEY no est√° definido"
            echo "   ‚ÑπÔ∏è  Por favor, agrega 'PROJECT_KEY' en:"
            echo "   GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   Name: PROJECT_KEY"
            echo "   Value: El key de tu proyecto en Jira (ej: PRUEB, TEST, etc.)"
            exit 0
          fi
          
          # 2. Verificar que el archivo existe
          if [ ! -f "test-results/junit.xml" ]; then
            echo "‚ö†Ô∏è  Advertencia: junit.xml no encontrado"
            echo "üìÅ Contenido de test-results/:"
            ls -la test-results/ || true
            exit 0
          fi
          
          echo "üìä Informaci√≥n del archivo:"
          echo "   Archivo: test-results/junit.xml"
          echo "   Tama√±o: $(wc -l < test-results/junit.xml) l√≠neas"
          
          # 3. Crear nombre √∫nico para el ciclo de pruebas
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
          TEST_CYCLE_NAME="Playwright Tests - ${{ matrix.env }} - $TIMESTAMP"
          
          echo ""
          echo "üéØ PAR√ÅMETROS PARA ZEPHYR:"
          echo "   Project Key: '$PROJECT_KEY'"
          echo "   Test Cycle: '$TEST_CYCLE_NAME'"
          echo "   Environment: ${{ matrix.env }}"
          echo "   API URL: $JIRA_BASE_URL/rest/atm/1.0/testrun/import"
          
          # 4. Subir a Zephyr Scale
          echo ""
          echo "üîÑ Enviando a Zephyr Scale..."
          
          response_code=$(curl -s -w "\n%{http_code}" -o /tmp/zephyr_response.json \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Content-Type: multipart/form-data" \
            -F "file=@test-results/junit.xml" \
            -F "projectKey=$PROJECT_KEY" \
            -F "testCycle=$TEST_CYCLE_NAME" \
            -F "autoCreateTestCases=true" \
            "$JIRA_BASE_URL/rest/atm/1.0/testrun/import")
          
          # Separar response body del c√≥digo HTTP
          http_code=$(echo "$response_code" | tail -n1)
          echo "üì® C√≥digo HTTP: $http_code"
          
          # Mostrar respuesta
          if [ -f "/tmp/zephyr_response.json" ]; then
            echo "üìÑ Respuesta de la API:"
            cat /tmp/zephyr_response.json
            echo ""
          fi
          
          # 5. Interpretar respuesta
          case $http_code in
            200|201)
              echo "‚úÖ ‚úÖ ‚úÖ √âXITO! Resultados subidos a Zephyr Scale"
              echo "üîç Revisa en Jira: $JIRA_BASE_URL"
              echo "   Proyecto: $PROJECT_KEY"
              echo "   Test Cycle: $TEST_CYCLE_NAME"
              ;;
            400)
              echo "‚ùå Bad Request (400)"
              echo "   Posibles causas:"
              echo "   ‚Ä¢ Project Key '$PROJECT_KEY' no existe"
              echo "   ‚Ä¢ Formato de archivo JUnit incorrecto"
              echo "   ‚Ä¢ Faltan par√°metros requeridos"
              ;;
            401)
              echo "‚ùå Unauthorized (401)"
              echo "   Credenciales de Jira incorrectas"
              ;;
            403)
              echo "‚ùå Forbidden (403)"
              echo "   Usuario no tiene permisos en el proyecto '$PROJECT_KEY'"
              ;;
            404)
              echo "‚ùå Not Found (404)"
              echo "   Posibles causas:"
              echo "   1. URL incorrecta: $JIRA_BASE_URL/rest/atm/1.0/testrun/import"
              echo "   2. Zephyr Scale no est√° instalado en tu Jira"
              echo "   3. La API ha cambiado"
              
              # Probar endpoint alternativo
              echo ""
              echo "üîÑ Probando endpoint alternativo..."
              curl -s -w "\nC√≥digo: %{http_code}\n" \
                -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
                -H "Content-Type: multipart/form-data" \
                -F "file=@test-results/junit.xml" \
                -F "projectKey=$PROJECT_KEY" \
                "$JIRA_BASE_URL/rest/tests/1.0/import/junit" || true
              ;;
            *)
              echo "‚ùå Error desconocido (HTTP $http_code)"
              ;;
          esac
          
          echo ""
          echo "üîç Para m√°s detalles, revisa el paso de DEBUG anterior"
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          PROJECT_KEY: ${{ secrets.PROJECT_KEY }}